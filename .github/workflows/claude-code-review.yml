name: Simple Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        
    - name: Code Review
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          console.log('🔍 Starting code review...');
          
          const prNumber = context.payload.pull_request.number;
          
          const files = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          let riskScore = 0;
          const issues = [];
          
          for (const file of files.data) {
            const changes = file.additions + file.deletions;
            if (changes > 100) riskScore += 2;
            
            if (file.patch && file.patch.includes('password')) {
              issues.push(`⚠️ Potential security issue in ${file.filename}`);
              riskScore += 5;
            }
          }
          
          const riskLevel = riskScore > 5 ? 'HIGH' : riskScore > 2 ? 'MEDIUM' : 'LOW';
          
          const comment = `## 🤖 Code Review
          
**Risk Level**: ${riskLevel}
**Files Changed**: ${files.data.length}

${issues.length > 0 ? '### Issues Found:\n' + issues.map(i => \`- ${i}\`).join('\n') : '✅ No issues detected'}

${riskLevel === 'LOW' ? '✅ Ready for merge' : '👀 Manual review recommended'}`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });
          
          const labels = ['ai-reviewed', riskLevel === 'LOW' ? 'auto-merge-ready' : 'needs-review'];
          
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            labels: labels
          });
          
          console.log('✅ Review complete')